<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>投資メモと電卓 無料ブラウザツール</title>
  <meta name="description" content="投資メモと電卓が無料で使えるWebツール。家計管理テンプレート、株式リンク集をワンストップで提供します.">
  <meta name="keywords" content="投資,電卓,メモ,株式リンク集">
  <meta name="google-adsense-account" content="ca-pub-3701488620779249">
  <link rel="canonical" href="https://memoc.pages.dev/toushi/">
  <style>
    /* 最低限のレスポンシブ調整 */
    #container{max-width:1100px;margin:0 auto;padding:12px;font-family:system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;}
    #banner h1 a{color:inherit;text-decoration:none;}
    /* デスクトップ：サイドを左に固定する既存スタイル */
    #links-left{float:left;width:280px;padding:8px;box-sizing:border-box;}
    #content{margin-left:300px;padding:8px;box-sizing:border-box; writing-mode: horizontal-tb;}
    #calculator{max-width:320px;}
    #calculator table{width:100%;border-collapse:collapse;}
    #calculator button{width:100%;padding:12px;font-size:1.05rem;}
    /* メモ textarea の調整 */
    textarea#memo { width:100%; box-sizing:border-box; max-width:100%; resize:vertical; min-height:180px; }
    /* QR画像の安定表示 */
    #links-left img { display:block; max-width:100%; height:auto; }
    /* モバイルでサイドを本文の下に配置するための調整
       DOM順は変更せず、CSSのorderで表示順を入れ替える */
    @media (max-width:800px){
      /* レイアウトをフレックスにして順序制御 */
      #container {
        display:flex;
        flex-direction:column;
      }
      /* links-leftを下に、contentを上に */
      #links-left{
        order:2;
        float:none;
        width:100%;
        padding:8px 0;
      }
      #content{
        order:1;
        margin-left:0;
        padding:8px 0;
      }
      /* bannerは先頭に */
      #banner{order:0;}
      /* 小さい画面でのカルキュレータ幅調整 */
      #calculator{max-width:100%;}
    }

h2 {
  font-size: 1.05rem;
  display: inline-block;
  padding: 6px 12px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgb(0, 255, 0), rgb(245, 255, 245));
  color: var(--accent-3);
  box-shadow: inset 0 -2px 0 rgba(96,165,250,0.06);
  margin-top: 0.3em;
}
h3 {
  font-size: 1rem;
  display: inline-block;
  padding: 6px 12px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgb(255, 255, 0), rgb(255, 255, 252));
  color: var(--accent-3);
  box-shadow: inset 0 -2px 0 rgba(96,165,250,0.06);
  margin-top: 1.6em;
}
h4 {
  font-size: 0.98rem;
  color: var(--accent-4);
  margin-top: 1.6em;
}
    /* 明示的に横書きを強制することで縦書き表示の不具合を防ぐ */
    body, #content, #container, #calculator, #links-left {
      writing-mode: horizontal-tb !important;
      -webkit-writing-mode: horizontal-tb !important;
    }
  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5D799GZERM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-5D799GZERM');
</script>
<body>
<div id="container">
  <div id="banner">
    <h1><a href="https://memoc.pages.dev/toushi/" rel="noopener noreferrer">投資メモ電卓webブラウザ無料サイト</a></h1>
    <div class="blockbody">
      <p>投資メモと電卓が無料の便利サイトです</p>
    </div>
  </div>

  <div id="links-left" aria-label="サイドナビゲーション">
    <div class="sidetitle">電卓ツール</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/memode/" target="_blank" rel="noopener noreferrer">メモ付き電卓webブラウザ無料サイト</a></p>
      <p><a href="https://memoc.pages.dev/muden/" target="_blank" rel="noopener noreferrer">電卓無料サイト</a></p>
    </div>
    <div class="sidetitle">時計ツール</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/tokei/" target="_blank" rel="noopener noreferrer">現在時刻リアルタイム秒時計Web表示</a></p>
      <p><a href="https://memoc.pages.dev/y985/" target="_blank" rel="noopener noreferrer">アナログ時計webアプリ表示切替機能付き</a></p>
    </div>
    <div class="sidetitle">タイマー</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/yzpa1/" target="_blank" rel="noopener noreferrer">タイマーおしゃれサイトの解説 3分で音が鳴る設定も簡単3タッチ</a></p>
      <p><a href="https://memoc.pages.dev/yzp1/" target="_blank" rel="noopener noreferrer">勉強タイマーおすすめwebサイトの説明 PCスマホ対応</a></p>
    </div>
    <div class="sidetitle">スケジュール・カレンダー</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/y992/" target="_blank" rel="noopener noreferrer">スケジュール帳ブラウザアプリ</a></p>
      <p><a href="https://memoc.pages.dev/y998s/" target="_blank" rel="noopener noreferrer">書き込みカレンダー無料で簡単作成</a></p>
    </div>
    <div class="sidetitle">家計・家電ツール</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/y997/" target="_blank" rel="noopener noreferrer">家計簿項目表のブラウザアプリ おすすめ無料フォーマット付</a></p>
      <p><a href="https://memoc.pages.dev/y988/" target="_blank" rel="noopener noreferrer">冷蔵庫ストッカー | 食品ロスを防ぐ消費期限管理アプリ</a></p>
      <p><a href="https://memoc.pages.dev/y989/" target="_blank" rel="noopener noreferrer">家の中の物の寿命一覧｜買い替え時期と次回購入日を自動計算</a></p>
    </div>
    <div class="sidetitle">名言・方言</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/y983/" target="_blank" rel="noopener noreferrer">気分で探す名言 — 今の気持ちで最適な一言を</a></p>
      <p><a href="https://memoc.pages.dev/y977/" target="_blank" rel="noopener noreferrer">四字熟語ジェネレーターとあいうえお一覧</a></p>
      <p><a href="https://memoc.pages.dev/y984/" target="_blank" rel="noopener noreferrer">日本全国方言比較辞典｜地域ごとの言葉の違い一覧</a></p>
    </div>
    <div class="sidetitle">お仕事ジェネレーター</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/y980/" target="_blank" rel="noopener">面接で使える質問テンプレ100｜ジェネレーター</a></p>
      <p><a href="https://memoc.pages.dev/y978/" target="_blank" rel="noopener">営業トークで使う発見質問50｜ジェネレーター</a></p>
      <p><a href="https://memoc.pages.dev/y979/" target="_blank" rel="noopener">カスタマー対応で使える質問例50｜ジェネレーター</a></p>
      <p><a href="https://memoc.pages.dev/y994/" target="_blank" rel="noopener">退職者へのメッセージジェネレーター上司・同僚・後輩・一言にも対応</a></p>
    </div>
    <div class="sidetitle">無料ゲーム</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/sensuikangame1/" target="_blank" rel="noopener noreferrer">潜水艦ゲーム 解説</a></p>
      <p><a href="https://memoc.pages.dev/senshagame1/" target="_blank" rel="noopener noreferrer">戦車ゲーム 無課金説明</a></p>
      <p><a href="https://memoc.pages.dev/kurumagamese/" target="_blank" rel="noopener noreferrer">車ゲーム ブラウザ</a></p>
    </div>
    <div class="sidetitle">学習ゲーム</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/y10k2/" target="_blank" rel="noopener noreferrer">英単語の覚えやすい方法</a></p>
      <p><a href="https://memoc.pages.dev/y6f2/" target="_blank" rel="noopener noreferrer">英語クイズ 小学生向け発音付き</a></p>
      <p><a href="https://memoc.pages.dev/y7g2/" target="_blank" rel="noopener noreferrer">英単語クイズ 小6 リスニング学習</a></p>
    </div>
    <div class="sidetitle">無料イラスト</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/peace/" target="_blank" rel="noopener noreferrer">ピースイラスト 着物など</a></p>
      <p><a href="https://memoc.pages.dev/xbuta/" target="_blank" rel="noopener noreferrer">豚イラスト 無料</a></p>
      <p><a href="https://memoc.pages.dev/xakushu/" target="_blank" rel="noopener noreferrer">握手イラスト 無料</a></p>
      <p><a href="https://memoc.pages.dev/xstar/" target="_blank" rel="noopener noreferrer">星イラスト 無料</a></p>
    </div>
    <div class="sidetitle">レジャー系コンテンツ</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/yuenchi/" target="_blank" rel="noopener noreferrer">遊園地 入場者ランキング トップ20</a></p>
      <p><a href="https://memoc.pages.dev/ueno/" target="_blank" rel="noopener noreferrer">上野動物園 ガイドと見どころ</a></p>
      <p><a href="https://memoc.pages.dev/sinkai/" target="_blank" rel="noopener noreferrer">深海魚 画像まとめ</a></p>
    </div>
    <div class="sidetitle">便利なコンテンツ</div>
    <div class="side">
      <p><a href="https://memoc.pages.dev/y981/" target="_blank" rel="noopener noreferrer">日付換算ツール 年齢計算と時間単位変換</a></p>
      <p><a href="https://memoc.pages.dev/y993/" target="_blank" rel="noopener noreferrer">くじ引きツール</a></p>
      <p><a href="https://memoc.pages.dev/" target="_blank" rel="noopener noreferrer">メモ帳代わりwebブラウザ便利サイト</a></p>
    </div>
    <div class="sidetitle">暮らし生活リンク</div>
    <div class="side">
      <a href="https://www.post.japanpost.jp/index/" target="_blank" rel="noopener noreferrer">郵便局</a><br>
      <a href="https://www.kuronekoyamato.co.jp/" target="_blank" rel="noopener noreferrer">ヤマト運輸</a><br>
      <a href="https://amzn.to/3RVk3jJ/" target="_blank" rel="noopener noreferrer">Amazon</a>
    </div>
    <div class="sidetitle">リンク</div>
    <div class="side">
      <a href="https://slun.web.fc2.com/" target="_blank" rel="noopener noreferrer">新宿ランチ会 相席の社会人サークル</a><br>
      <a href="https://katam.web.fc2.com/" target="_blank" rel="noopener noreferrer">肩にこり枕</a><br>
      <a href="https://tuboli.web.fc2.com/" target="_blank" rel="noopener noreferrer">ツボの理屈</a><br>
      <a href="https://takra.web.fc2.com/" target="_blank" rel="noopener noreferrer">卓球中古ラケット 激安店</a>
    </div>
    <div class="sidetitle">ＱＲコード</div>
    <div class="side"><img alt="投資メモサイトのQRコード" src="https://memoc.pages.dev/images/memochou.png" width="220" height="220"></div>
  </div>

  <div id="content" role="main">
    <h2>投資メモ 株式リンク集</h2>
    <p>投資メモと電卓が無料で使える当サイトは、積立NISAや長期投資の金額シミュレーション、投資メモの保存、日々の株価チェック用リンク集をワンストップで提供します。初心者向けに「少額から始める投資」「複利の効果」「リスク管理の基本」も分かりやすく解説しています。</p>

    <!-- メモフォーム -->
    <section aria-labelledby="memo-heading">
      <h3 id="memo-heading">投資メモ 保存欄</h3>
      <form id="memoForm" autocomplete="off">
        <label for="memo" class="visually-hidden">投資メモ入力欄</label>
        <textarea id="memo" name="memo" rows="14" cols="68" wrap="soft" aria-label="投資メモ入力欄">投資メモ
</textarea>
        <div>
          <button type="button" id="memoSave" aria-label="メモを保存する">保存</button>
          <button type="button" id="memoClear" aria-label="メモを消去する">消去</button>
        </div>
        <p id="memoNotice" aria-live="polite"></p>
      </form>
    </section>

    <p><a href="https://memoc.pages.dev/interestcalculation/" target="_blank" rel="noopener noreferrer">複利電卓 無料 積立NISAの金額再投資計算機</a></p>
    <p>こちらの複利電卓 積立NISAの金額再投資計算機は、無料でお使いいただけます。</p>

    <p>投資用株式リンク集　
      <a href="https://finance.yahoo.co.jp/quote/998407.O/chart" target="_blank" rel="noopener noreferrer">日経平均チャート</a>
      <a href="https://finance.yahoo.co.jp/quote/%5EDJI/chart" target="_blank" rel="noopener noreferrer">NYダウチャート</a>
      <a href="https://finance.yahoo.co.jp/quote/%5EIXIC/chart" target="_blank" rel="noopener noreferrer">ナスダックチャート</a>
    </p>

    <p>
      <a href="https://nikkei225jp.com/chart/" target="_blank" rel="noopener noreferrer">日経平均リアルタイムチャート</a>
      <a href="https://nikkei225jp.com/nasdaq/" target="_blank" rel="noopener noreferrer">NYダウ平均株価リアルタイムチャート</a>
    </p>

    <p>
      <a href="https://finance.yahoo.co.jp/" target="_blank" rel="noopener noreferrer">ヤフーファイナンス</a>
      <a href="https://finance.yahoo.co.jp/stocks/ranking/up" target="_blank" rel="noopener noreferrer">値上がりランキング</a>
      <a href="https://finance.yahoo.co.jp/stocks/ranking/down" target="_blank" rel="noopener noreferrer">値下がりランキング</a>
      <a href="https://finance.yahoo.co.jp/stocks/ranking/stopHigh" target="_blank" rel="noopener noreferrer">ストップ高</a>
      <a href="https://finance.yahoo.co.jp/stocks/ranking/stopLow" target="_blank" rel="noopener noreferrer">ストップ安</a>
      <a href="https://finance.yahoo.co.jp/stocks/ranking/volume" target="_blank" rel="noopener noreferrer">出来高</a>
    </p>

    <p><a href="https://kabutan.jp/" target="_blank" rel="noopener noreferrer">株探</a>　　<a href="https://minkabu.jp/" target="_blank" rel="noopener noreferrer">みんかぶ</a></p>
    <p><a href="https://www.nikkei.com/" target="_blank" rel="noopener noreferrer">日本経済新聞</a></p>

    <h3>株初心者は何から始めるか まずは少額から NISA のすすめ</h3>
    <p>投資初心者におすすめのスタートは、少額投資と知識の習得です。まずは投資の入門書を読み、10万円程度の少額から実際に始め、積立NISAなど非課税枠を活用して長期分散投資を行いましょう。</p>

    <h4>信用取引とレバレッジの注意点</h4>
    <p>信用取引は高いリスクを伴い、暴落局面で損失が大きく膨らむ可能性があります。長期の資産形成を目指すなら現物中心の運用と資金管理を優先してください。</p>

    <h3>電卓 web ブラウザ 計算機とメモ帳</h3>
    <div id="calculator" aria-labelledby="calc-heading">
      <h4 id="calc-heading">簡易電卓</h4>
      <!-- disabled を readonly に変更して選択やコピーを可能にする -->
      <input type="text" id="display" aria-label="電卓表示" readonly>
      <table role="grid" aria-label="電卓キー" role="group" aria-roledescription="電卓">
        <tr>
          <td><button type="button" onclick="appendToDisplay('7')" aria-label="数字7">7</button></td>
          <td><button type="button" onclick="appendToDisplay('8')" aria-label="数字8">8</button></td>
          <td><button type="button" onclick="appendToDisplay('9')" aria-label="数字9">9</button></td>
          <td><button type="button" onclick="appendToDisplay('+')" aria-label="足す">+</button></td>
        </tr>
        <tr>
          <td><button type="button" onclick="appendToDisplay('4')" aria-label="数字4">4</button></td>
          <td><button type="button" onclick="appendToDisplay('5')" aria-label="数字5">5</button></td>
          <td><button type="button" onclick="appendToDisplay('6')" aria-label="数字6">6</button></td>
          <td><button type="button" onclick="appendToDisplay('-')" aria-label="引く">-</button></td>
        </tr>
        <tr>
          <td><button type="button" onclick="appendToDisplay('1')" aria-label="数字1">1</button></td>
          <td><button type="button" onclick="appendToDisplay('2')" aria-label="数字2">2</button></td>
          <td><button type="button" onclick="appendToDisplay('3')" aria-label="数字3">3</button></td>
          <td><button type="button" onclick="appendToDisplay('*')" aria-label="掛ける">*</button></td>
        </tr>
        <tr>
          <td><button type="button" onclick="appendToDisplay('0')" aria-label="数字0">0</button></td>
          <td><button type="button" onclick="backspace()" aria-label="一文字削除">←</button></td>
          <td><button type="button" onclick="calculateResult()" aria-label="計算実行">=</button></td>
          <td><button type="button" onclick="appendToDisplay('/')" aria-label="割る">/</button></td>
        </tr>
        <tr>
          <td><button type="button" onclick="appendToDisplay('(')" aria-label="左括弧">(</button></td>
          <td><button type="button" onclick="appendToDisplay(')')" aria-label="右括弧">)</button></td>
          <td><button type="button" onclick="appendToDisplay('.')" aria-label="小数点">.</button></td>
          <td><button type="button" onclick="clearDisplay()" aria-label="クリア">C</button></td>
        </tr>
      </table>
      <p id="calcNotice" aria-live="polite"></p>
    </div>

    <!-- FAQ for search snippets -->
    <section aria-labelledby="faq-heading">
      <h3 id="faq-heading">よくある質問</h3>
      <dl>
        <dt>投資メモと電卓は無料ですか</dt>
        <dd>はい。投資メモと電卓はブラウザ上で無料で利用できます。追加料金はありません。</dd>
        <dt>積立NISAのシミュレーションは正確ですか</dt>
        <dd>シミュレーションは基本的な複利計算で将来の目安を示します。実際の運用成績は変動します。</dd>
        <dt>メモはどこに保存されますか</dt>
        <dd>メモはブラウザのローカルストレージに保存されます。端末を消去するとメモは消えるため必要ならバックアップを行ってください。</dd>
        <dt>スマホでも使えますか</dt>
        <dd>はい。レスポンシブ対応でスマホ／タブレットでも使いやすく設計しています。</dd>
      </dl>
    </section>

    <hr>

    <h3>株式証券会社 銀行の便利リンク集</h3>
    <p>株式証券会社・NISA積み立て　
      <a href="https://www.nomura.co.jp/" target="_blank" rel="noopener noreferrer">野村證券</a>
      <a href="https://www.daiwa.jp/" target="_blank" rel="noopener noreferrer">大和証券</a>
      <a href="https://www.mizuho-sc.com/" target="_blank" rel="noopener noreferrer">みずほ証券</a>
      <a href="https://www.smbcnikko.co.jp/" target="_blank" rel="noopener noreferrer">SMBC日興証券</a>
      <a href="https://www.sc.mufg.jp/" target="_blank" rel="noopener noreferrer">三菱UFJモルガン・スタンレー証券</a>
      <a href="https://www.sbisec.co.jp/" target="_blank" rel="noopener noreferrer">SBI証券</a>
      <a href="https://www.rakuten-sec.co.jp/" target="_blank" rel="noopener noreferrer">楽天証券</a>
      <a href="https://www.click-sec.com/" target="_blank" rel="noopener noreferrer">GMOクリック証券</a>
      <a href="https://www.sbineotrade.jp/" target="_blank" rel="noopener noreferrer">SBIネオトレード証券</a>
    </p>
    <p>銀行　
      <a href="https://www.jp-bank.japanpost.jp/" target="_blank" rel="noopener noreferrer">ゆうちょ銀行</a>
      <a href="https://www.bk.mufg.jp/" target="_blank" rel="noopener noreferrer">三菱UFJ銀行</a>
      <a href="https://www.smbc.co.jp/" target="_blank" rel="noopener noreferrer">三井住友銀行</a>
      <a href="https://www.mizuhobank.co.jp/" target="_blank" rel="noopener noreferrer">みずほ銀行</a>
      <a href="https://www.resonabank.co.jp/" target="_blank" rel="noopener noreferrer">りそな銀行</a>
      <a href="https://www.sbishinseibank.co.jp/" target="_blank" rel="noopener noreferrer">SBI新生銀行</a>
      <a href="https://www.netbk.co.jp/contents/" target="_blank" rel="noopener noreferrer">住信SBIネット銀行</a>
      <a href="https://www.jibunbank.co.jp/" target="_blank" rel="noopener noreferrer">au じぶん銀行</a>
      <a href="https://www.rakuten-bank.co.jp/" target="_blank" rel="noopener noreferrer">楽天銀行</a>
      <a href="https://moneykit.net/" target="_blank" rel="noopener noreferrer">ソニー銀行</a>
    </p>
  </div> <!-- #content -->

  <div style="clear:both"></div>
</div> <!-- #container -->

<!-- ここで修正済みのJSを読み込む（ページ内で直接埋め込む場合は下に script を置く） -->
<script>
/* 以下は上で提示した toushi-fix.js の中身をページ内に直接埋める場合の実行スニペットです。
   サイト運用上は外部ファイルとして読み込むほうが望ましいです。 */
(function(){

  /* ---------- メモ機能 ---------- */
  const textarea = document.getElementById('memo');
  const saveBtn = document.getElementById('memoSave');
  const clearBtn = document.getElementById('memoClear');
  const notice = document.getElementById('memoNotice');
  const STORAGE_KEY = 'toushi_memo_v1';

  function safeSetItem(key, value){
    try { localStorage.setItem(key, value); return true; } catch (e) { return false; }
  }
  function safeGetItem(key){
    try { return localStorage.getItem(key); } catch (e) { return null; }
  }
  function safeRemoveItem(key){
    try { localStorage.removeItem(key); return true; } catch (e) { return false; }
  }

  const saved = safeGetItem(STORAGE_KEY);
  if(saved) textarea.value = saved;

  let saveTimer = null;
  textarea.addEventListener('input', function(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(function(){
      const ok = safeSetItem(STORAGE_KEY, textarea.value);
      if(ok){
        notice.textContent = 'メモを自動保存しました';
      } else {
        notice.textContent = '自動保存に失敗しました。重要ならコピーして保存してください。';
      }
      setTimeout(()=>{ notice.textContent = '' }, 1800);
    }, 700);
  });

  saveBtn.addEventListener('click', function(){
    const ok = safeSetItem(STORAGE_KEY, textarea.value);
    if(ok){ notice.textContent = 'メモを保存しました'; }
    else { notice.textContent = '保存に失敗しました。コピーして外部にバックアップしてください。'; }
    setTimeout(()=>{ notice.textContent = '' }, 1800);
  });

  clearBtn.addEventListener('click', function(){
    if(confirm('メモを消去しますか？')){
      textarea.value = '';
      safeRemoveItem(STORAGE_KEY);
      notice.textContent = 'メモを消去しました';
      setTimeout(()=>{ notice.textContent = '' }, 1500);
    }
  });

  /* ---------- 電卓機能 ---------- */
  const display = document.getElementById('display');
  const calcNotice = document.getElementById('calcNotice');

  (function ensureHorizontalWriting(){
    if(display){ display.style.writingMode = 'horizontal-tb'; }
    const content = document.getElementById('content');
    if(content){ content.style.writingMode = 'horizontal-tb'; }
  })();

  function isUserTypingInField(){
    const elem = document.activeElement;
    if(!elem) return false;
    const tag = elem.tagName;
    if(tag === 'TEXTAREA' || tag === 'INPUT') return true;
    if(elem.isContentEditable) return true;
    return false;
  }

  window.appendToDisplay = function(value){
    display.value = (display.value || '') + value;
  };

  window.clearDisplay = function(){
    display.value = '';
    calcNotice.textContent = '';
  };

  window.backspace = function(){
    display.value = (display.value || '').slice(0, -1);
  };

  const ALLOWED_CHARS = /^[0-9+\-*/().\s%]+$/;

  function balancedParentheses(s){
    let depth = 0;
    for(let i=0;i<s.length;i++){
      const c = s[i];
      if(c === '(') depth++;
      if(c === ')'){
        depth--;
        if(depth < 0) return false;
      }
    }
    return depth === 0;
  }

  function validateExpression(s){
    if(!s || !s.trim()) { calcNotice.textContent = '式を入力してください'; return false; }
    if(!ALLOWED_CHARS.test(s)){ calcNotice.textContent = '無効な文字が含まれています'; return false; }
    if(!balancedParentheses(s)){ calcNotice.textContent = '括弧が整合していません'; return false; }
    if(/[+\-*/]{2,}/.test(s.replace(/\s+/g,''))){ calcNotice.textContent = '演算子が連続しています'; return false; }
    if(/^[+\/*)]|[+\-*/.]$/.test(s.trim())){ calcNotice.textContent = '式の先頭または末尾が不正です'; return false; }
    if(/\.\.+/.test(s)){ calcNotice.textContent = '小数点の使い方が不正です'; return false; }
    return true;
  }

  window.calculateResult = function(){
    const exprRaw = (display.value || '').trim();
    if(!exprRaw){ calcNotice.textContent = '式を入力してください'; return; }
    if(!validateExpression(exprRaw)) { display.value = 'Error'; return; }
    const replaced = exprRaw.replace(/([0-9]+(?:\.[0-9]+)?)%/g, '($1/100)');
    if(!ALLOWED_CHARS.test(replaced)){ display.value = 'Error'; calcNotice.textContent = '無効な文字が含まれています'; return; }
    try {
      const fn = new Function('"use strict"; return (' + replaced + ');');
      const result = fn();
      if(typeof result === 'number' && isFinite(result)){
        display.value = String(result);
        calcNotice.textContent = '';
      } else {
        display.value = 'Error';
        calcNotice.textContent = '計算結果が無効です';
      }
    } catch (e) {
      display.value = 'Error';
      calcNotice.textContent = '計算に失敗しました';
    }
  };

  document.addEventListener('keydown', function(e){
    const key = e.key;
    if(isUserTypingInField()) return;
    if(/^[0-9+\-*/().%]$/.test(key)) { appendToDisplay(key); e.preventDefault(); }
    else if(key === 'Enter'){ calculateResult(); e.preventDefault(); }
    else if(key === 'Backspace'){ backspace(); e.preventDefault(); }
    else if(key === 'Escape'){ clearDisplay(); }
  }, false);

})();
</script>
</body>
</html>